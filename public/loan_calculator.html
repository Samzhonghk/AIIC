<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create New Loan for Existing Customer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: #333; }
        .container { max-width: 700px; margin: 40px auto; }
        .card { border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border: none; }
        .card-title { color: #3498db; font-weight: bold; }
        .form-section { margin-bottom: 32px; }
    </style>
</head>
<body>
    <div class="container">
        <!-- 客户信息展示 -->
        <div class="card form-section">
            <div class="card-body">
                <h4 class="card-title mb-3">Customer Information</h4>
                <div id="customerInfo">
                    <div class="mb-2"><strong>Customer Number:</strong> <span id="customerNumber"></span></div>
                    <div class="mb-2"><strong>Customer Name:</strong> <span id="customerName"></span></div>
                    <div class="mb-2"><strong>Phone:</strong> <span id="customerPhone"></span></div>
                    <div class="mb-2"><strong>Address:</strong> <span id="customerAddress"></span></div>
                </div>
            </div>
        </div>
        <!-- 新贷款表单 -->
        <div class="card">
            <div class="card-body">
                <h4 class="card-title mb-3">Create New Loan</h4>
                <form id="loanForm">
                    <div class="mb-3">
                        <label class="form-label">Created Date</label>
                        <input type="text" class="form-control" id="createdDate" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Loan Amount</label>
                        <input type="number" class="form-control" id="loanAmount" required min="1">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Interest Amount</label>
                        <select class="form-select" id="interestSelect">
                            <option value="0.4">40%</option>
                            <option value="0.3">30%</option>
                            <option value="0.2">20%</option>
                            <option value="0.1">10%</option>
                        </select>
                        <input type="number" class="form-control mt-2" id="interestAmount" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Payment Frequency</label>
                        <select class="form-select" id="paymentFrequency">
                            <option value="7">Weekly</option>
                            <option value="14">Fornightly</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Total Payment Amount</label>
                        <input type="number" class="form-control" id="paymentAmount" required min="0" value="0" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Repay Amount (per installment)</label>
                        <input type="number" class="form-control" id="repayAmount" required min="100" value="100" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Term (number of payments)</label>
                        <input type="number" class="form-control" id="term" readonly>
                        <div id="termError" class="text-danger small mt-1" style="display:none">term is invalid, please adjust Payment Amount or Payment Frequency.</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Payment Due Date</label>
                        <input type="text" class="form-control" id="paymentDueDate" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Lender Print Name</label>
                        <input type="text" class="form-control" id="lenderName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Customer Name</label>
                        <input type="text" class="form-control" id="customerNameInput" readonly>
                    </div>
                    <button type="submit" class="btn btn-primary">Create Loan</button>
                    <a href="client_list.html" class="btn btn-secondary ms-2">Cancel</a>
                </form>
                <div id="result" class="mt-4"></div>
            </div>
        </div>
    </div>
    <script>
        // 获取客户号参数
        function getQueryParam(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }
        // 通过后端接口获取客户信息
        async function fetchCustomerInfo(customerId) {
            try {
                const res = await fetch(`/api/clients/${encodeURIComponent(customerId)}`);
                console.log('Fetch customer response status:', res.status);
                if (!res.ok) throw new Error('Customer not found');
                return await res.json();
            } catch (err) {
                return null;
            }
        }
        // 自动生成 Loan Number（实际应从数据库获取最大值+1）
        // let loanNumberSeed = 1;
        // function padLoanNumber(num) {
        //     return num.toString().padStart(6, '0');
        // }
        // function getNextLoanNumber() {
        //     // 实际应从后端获取最大 loan number
        //     return padLoanNumber(loanNumberSeed++);
        // }

        // 设置客户信息（异步获取）
        const customerId = getQueryParam('customerNumber') || getQueryParam('customer_id') || '';
        async function setCustomerInfo() {
            if (!customerId) return;
            const customer = await fetchCustomerInfo(customerId);
            console.log('Fetched customer name:', customer.client.name);
            document.getElementById('customerNumber').textContent = customer ? customer.client.id : customerId;
            document.getElementById('customerName').textContent = customer ? customer.client.name : '';
            document.getElementById('customerPhone').textContent = customer ? customer.client.phone : '';
            document.getElementById('customerAddress').textContent = customer ? customer.client.address : '';
            document.getElementById('customerNameInput').value = customer ? customer.client.name : '';
        }
        setCustomerInfo();
        // 设置 Loan Number 和 Created Date
        // document.getElementById('loanNumber').value = getNextLoanNumber();
        // 新西兰时间（奥克兰）
        function getNZDateString() {
            const now = new Date();
            // 直接用 toLocaleString 获取奥克兰时间的年月日
            const nztString = now.toLocaleString('en-NZ', {
                timeZone: 'Pacific/Auckland',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
            // nztString 格式如 "11/10/2025"（NZ: 日/月/年）或 "10/11/2025"（美式: 月/日/年），需按 NZ 格式处理
            const parts = nztString.split('/');
            // 兼容不同浏览器，优先按 NZ 格式（日/月/年）
            let day, month, year;
            if (parseInt(parts[0], 10) > 12) {
                // 第一个数字大于12，肯定是日
                day = parts[0]; month = parts[1]; year = parts[2];
            } else {
                // 否则按 NZ 格式
                day = parts[0]; month = parts[1]; year = parts[2];
            }
            return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
        }
        document.getElementById('createdDate').value = getNZDateString();
        // 标记用户是否手动编辑了总还款（paymentAmount）
        let totalEdited = false;

        // 利息额自动计算；如果用户未手动改动总还款，则自动把 Total Payment 填为 本金 + 利息
        function updateInterestAmount() {
            const loanAmount = parseFloat(document.getElementById('loanAmount').value) || 0;
            const interestRate = parseFloat(document.getElementById('interestSelect').value) || 0;
            const interest = loanAmount * interestRate;
            document.getElementById('interestAmount').value = interest.toFixed(2);
            const paymentInput = document.getElementById('paymentAmount');
            if (!totalEdited) {
                paymentInput.value = (loanAmount + interest).toFixed(2);
            }
            // 更新期数/到期日
            updatePaymentDueDate();
        }
        document.getElementById('loanAmount').addEventListener('input', updateInterestAmount);
        // 禁止 Loan Amount 为负数
        document.getElementById('loanAmount').addEventListener('input', function() {
            const input = document.getElementById('loanAmount');
            if (parseFloat(input.value) < 0) {
                input.value = '';
                document.getElementById('interestAmount').value = '';
                alert('Loan Amount Cannot be negative');
            }
        });
        document.getElementById('interestSelect').addEventListener('change', updateInterestAmount);
        // 还款日自动计算
        function getNextFriday(date) {
            const d = new Date(date);
            const day = d.getDay();
            const daysToFriday = (5 - day + 7) % 7 || 7;
            d.setDate(d.getDate() + daysToFriday);
            return d;
        }
        function round2(n) { return Math.round((n + Number.EPSILON) * 100) / 100; }

        // 计算期数：根据总额(total) 和 每次还款(repayAmount) 以及频率(frequencyDays)
        function computeTermFromTotalAndPer(total, per) {
            if (!per || per <= 0) return 0;
            return Math.ceil(total / per);
        }

        function updatePaymentDueDate() {
            const loanAmount = parseFloat(document.getElementById('loanAmount').value) || 0;
            const interestAmount = parseFloat(document.getElementById('interestAmount').value) || 0;
            const paymentAmount = parseFloat(document.getElementById('paymentAmount').value) || 0; // total payment
            const repayAmount = parseFloat(document.getElementById('repayAmount').value) || 100; // per installment
            const frequencyDays = parseInt(document.getElementById('paymentFrequency').value);
            // frequencyDays is 7 or 14
            // 简单最小值校验：每周 repay 最小 100，每两周 repay 最小 200
            if ((frequencyDays === 7 && repayAmount < 100) || (frequencyDays === 14 && repayAmount < 200)) return;
            const total = (paymentAmount > 0) ? paymentAmount : (loanAmount + interestAmount);
            const periods = computeTermFromTotalAndPer(total, repayAmount);
            const termInput = document.getElementById('term');
            const termError = document.getElementById('termError');
            const submitBtn = document.querySelector('button[type="submit"]');
            if (!periods || periods <= 0 || !Number.isFinite(periods)) {
                termInput.value = '';
                termError.style.display = 'block';
                if (submitBtn) submitBtn.disabled = true;
            } else {
                termInput.value = periods;
                termError.style.display = 'none';
                if (submitBtn) submitBtn.disabled = false;
            }

            const createdDate = document.getElementById('createdDate').value;
            let dueDate = getNextFriday(createdDate);
            dueDate.setDate(dueDate.getDate() + frequencyDays * periods);
            document.getElementById('paymentDueDate').value = dueDate.toISOString().split('T')[0];
        }
        document.getElementById('loanAmount').addEventListener('input', updatePaymentDueDate);
        document.getElementById('interestAmount').addEventListener('input', updatePaymentDueDate);
        // 如果用户手动编辑了总还款，设置标志避免自动覆盖
        document.getElementById('paymentAmount').addEventListener('input', function() {
            totalEdited = true;
            updatePaymentDueDate();
        });
    document.getElementById('repayAmount').addEventListener('input', updatePaymentDueDate);
        document.getElementById('paymentFrequency').addEventListener('change', updatePaymentDueDate);
        // 动态调整每次还款金额的最小值（select 的值现在是以天为单位：7 或 14）
        document.getElementById('paymentFrequency').addEventListener('change', function() {
            const freq = parseInt(document.getElementById('paymentFrequency').value, 10);
            const repayAmountInput = document.getElementById('repayAmount');
            // 每周 (7 天) repay 最小 100，每两周 (14 天) repay 最小 200
            if (freq === 7) {
                repayAmountInput.min = 100;
                // always set to weekly default so UI reflects the change
                repayAmountInput.value = 100;
            } else if (freq === 14) {
                repayAmountInput.min = 200;
                // always set to fortnightly default
                repayAmountInput.value = 200;
            }
            // 频率改变后刷新期数和到期日显示
            updatePaymentDueDate();
        });
        document.getElementById('createdDate').addEventListener('input', updatePaymentDueDate);
        // 初始化利息和还款日
        updateInterestAmount();
        updatePaymentDueDate();
        // 表单提交：先发送到后端 /api/loans，如果失败则把数据保存到 sessionStorage，最后跳转到 e_contract.html
        document.getElementById('loanForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            // final validation: term must be > 0
            const termVal = parseInt(document.getElementById('term').value) || 0;
            if (!termVal || termVal <= 0) {
                document.getElementById('termError').style.display = 'block';
                alert('Term is invalid, please adjust Payment Amount or Payment Frequency before submitting');
                return;
            }

            const payload = {
                createdDate: document.getElementById('createdDate').value,
                loanAmount: parseFloat(document.getElementById('loanAmount').value) || 0,
                interestRate: parseFloat(document.getElementById('interestSelect').value) || 0,
                interestAmount: parseFloat(document.getElementById('interestAmount').value) || 0,
                paymentFrequency: parseInt(document.getElementById('paymentFrequency').value) || 7,
                paymentAmount: parseFloat(document.getElementById('paymentAmount').value) || 0, // total
                repayAmount: parseFloat(document.getElementById('repayAmount').value) || 0, // per installment
                term: parseInt(document.getElementById('term').value) || 0,
                paymentDueDate: document.getElementById('paymentDueDate').value,
                lenderName: document.getElementById('lenderName').value,
                customerId: customerId,
                customerName: document.getElementById('customerNameInput').value
            };

            try {
                const res = await fetch('/api/loans', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (res.ok) {
                    const data = await res.json();
                    const loanNumber = data.loanNumber;
                    window.location.href = `e_contract.html?loanNumber=${encodeURIComponent(loanNumber)}`;
                } else {
                    alert('Failed to create loan');
                }
            } catch (err) {
                console.error('Error creating loan:', err);
            }
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Repay Schedule</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    .container { max-width:900px; margin:40px auto; }
    .card { padding:20px; border-radius:8px; }
    .table th, .table td { vertical-align:middle; }
    .remain-box { text-align: right; margin-bottom: 8px; }
    .remain-amount { font-size: 1.1rem; font-weight: 600; color: #c0392b; }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h3>Payment for existing customer</h3>
      <p id="info" class="text-muted"></p>
      <p id="info_clientName" class="text-muted"></p>
      <!-- <p>
        <strong id="info" class="text-muted"></strong>
        <strong id="info_clientName" class="text-muted"></strong>
      </p> -->
      
      <div id="content">Loading...</div>
      <a id="backBtn" class="btn btn-secondary mt-3">Back</a>
    </div>
  </div>
  <script>
    function getQueryParam(name){ const u = new URL(window.location.href); return u.searchParams.get(name); }
    const clientNumber = getQueryParam('clientNumber');
    // const clientName = getQueryParam('clientName');
    document.getElementById('backBtn').addEventListener('click', ()=> window.history.back());
    if(!clientNumber){ document.getElementById('content').innerHTML = '<p class="text-danger">Missing clientNumber</p>'; }
    else{
      document.getElementById('info').textContent = 'Client Number: ' + clientNumber;
      // 请求客户信息并显示客户姓名（若有）
      fetch('/api/clients/' + encodeURIComponent(clientNumber)).then(r => {
        if (!r.ok) throw new Error('no client');
        return r.json();
      }).then(cdata => {
        try {
          const name = cdata && cdata.client ? (cdata.client.name || cdata.client.client_name || '') : (cdata && cdata.name ? cdata.name : '');
          if (name) document.getElementById('info_clientName').textContent = 'Client Name: ' + name;
        } catch (e) { /* ignore */ }
      }).catch(() => {
        // ignore failures
      });
      function renderRepayData(data){
        if(!Array.isArray(data) || data.length===0){ document.getElementById('content').innerHTML = '<p class="text-warning">No repay records found.</p>'; return; }
        // late fee configuration: flat fee once overdue (25 NZD)
        const LATE_FEE_FLAT = 25.00;
        const now = Math.floor(Date.now()/1000);
  let rowsHTML = '';
  let totalPaid = 0;
  let totalLateFee = 0;
  let totalRemainingPrincipal = 0;
        for(const it of data){
          const repayId = it.repay_id || '';
          const loanId = it.loan_id || it.loan_number || '';
          const repayDate = it.repay_date || 0;
          const dueDate = Number(it.due_date) || 0;
          const repayAmount = (it.repay_amount!=null? Number(it.repay_amount) : (it.repayAmount!=null? Number(it.repayAmount) : 0)) || 0;
          const paidAmount = it.paid_amount != null ? Number(it.paid_amount) : 0;
          // calculate late fee: fixed fee charged once when overdue and not fully paid
          let lateFee = 0;
          if(dueDate > 0 && now > dueDate && paidAmount < repayAmount){
            lateFee = LATE_FEE_FLAT;
          }
          totalPaid += paidAmount;
          // prefer stored late_fee if present in data, otherwise use computed suggestion
          const storedLate = (it.late_fee != null) ? Number(it.late_fee) : lateFee;
          totalLateFee += storedLate;
          // remaining principal for this row
          const remainingThis = Math.max(repayAmount - paidAmount, 0);
          totalRemainingPrincipal += remainingThis;

          const lateFeeDisabled = (lateFee <= 0);
          // determine if this row should be selectable: disable if already fully paid
          const isPaid = (it.status === 'paid') || (paidAmount >= repayAmount && repayAmount > 0);
          const radioDisabledAttr = isPaid ? 'disabled' : '';
          const rowClass = isPaid ? 'table-secondary text-muted' : '';
          rowsHTML += `<tr class="${rowClass}" data-repay-id="${repayId}" data-loan-id="${loanId}" data-client-id="${it.client_id || ''}" data-due-date="${dueDate}" data-repay-amount="${repayAmount.toFixed(2)}">
            <td><input type="radio" name="selectedRepay" value="${repayId}" ${radioDisabledAttr}></td>
            <td>${repayId}</td>
            <td>${loanId}</td>
            <td>${new Date(repayDate*1000).toLocaleDateString()}</td>
            <td>${dueDate? new Date(dueDate*1000).toLocaleDateString() : ''}</td>
            <td>${repayAmount.toFixed(2)}</td>
            <td>${paidAmount.toFixed(2)}</td>
            <td>${it.status || ''}</td>
            <td>
              <div class="d-flex align-items-center">
                <input type="number" step="0.01" class="form-control form-control-sm lateFeeInput" value="${lateFee.toFixed(2)}" style="width:100px;" ${lateFeeDisabled || isPaid? 'disabled' : ''}>
                <div class="form-check form-check-inline ms-2">
                  <input class="form-check-input lateFeeOverride" type="checkbox" ${lateFeeDisabled || isPaid? '' : 'checked'} title="Check to edit late fee" ${isPaid? 'disabled' : ''}>
                </div>
              </div>
            </td>
          </tr>`;
        }

        document.getElementById('content').innerHTML = `
          <div class="remain-box">
            <div class="remain-amount">Remaining: NZ$${totalRemainingPrincipal.toFixed(2)}</div>
            <div class="text-muted">Including late fees: NZ$${(totalRemainingPrincipal + totalLateFee).toFixed(2)}</div>
          </div>
          <table class="table table-striped">
            <thead><tr><th></th><th>Repay ID</th><th>Loan</th><th>Repay Date</th><th>Due Date</th><th>Amount</th><th>Paid</th><th>Status</th><th>Late Fee</th></tr></thead>
            <tbody>${rowsHTML}</tbody>
          </table>
            <div class="mt-2 mb-3">
            <strong>Total Already Paid:</strong> <span id="totalPaid">${totalPaid.toFixed(2)}</span>
            <span class="ms-4"><strong>Total Late Fee:</strong> <span id="totalLateFee">${totalLateFee.toFixed(2)}</span></span>
            <span class="ms-4 text-muted">(Late fee: NZ$${LATE_FEE_FLAT.toFixed(2)} per overdue every term)</span>
          </div>
            <div class="mt-3">
            <label for="recordAmount">Repay Amount :</label>
            <input id="recordAmount" class="form-control mb-2" type="number" step="0.01" min="0.01" placeholder="Enter amount to repay">
            <div id="recordMinMsg" class="form-text text-muted mb-2"></div>
            <label for="recordRemark">Remark (optional):</label>
            <input id="recordRemark" class="form-control mb-2" type="text" placeholder="Remark">
            <button id="recordBtn" class="btn btn-success">Repay</button>
            <div id="recordMsg" class="mt-2"></div>
          </div>
        `;

        // enable override toggles for late fee inputs
        document.querySelectorAll('.lateFeeOverride').forEach(chk => {
          chk.addEventListener('change', function(){
            const tr = this.closest('tr');
            const input = tr.querySelector('.lateFeeInput');
            if(input) input.disabled = !this.checked;
          });
        });

        // when a repayment row is selected, update the recordAmount min and show hint
        function onRepayRowSelected(e){
          const sel = e.target;
          const tr = sel.closest('tr');
          const scheduled = parseFloat(tr.getAttribute('data-repay-amount')) || 0;
          const recordAmountEl = document.getElementById('recordAmount');
          // store the scheduled min in dataset (reliable source for validation)
          recordAmountEl.dataset.scheduledMin = String(scheduled);
          recordAmountEl.min = scheduled.toFixed(2);
          const hint = document.getElementById('recordMinMsg');
          if(hint) hint.textContent = 'Minimum pay: NZ$' + scheduled.toFixed(2);
        }
        document.querySelectorAll('input[name="selectedRepay"]').forEach(r=> r.addEventListener('change', onRepayRowSelected));

        // submission handler moved into a reusable function
        async function handleRecordClick(){
          const sel = document.querySelector('input[name="selectedRepay"]:checked');
          const msg = document.getElementById('recordMsg');
          msg.textContent = '';
          if(!sel){ msg.innerHTML = '<span class="text-danger">Please select a repayment row first.</span>'; return; }
          const repayId = sel.value;
          const tr = sel.closest('tr');
          const loanId = tr.getAttribute('data-loan-id');
          const clientId = tr.getAttribute('data-client-id');
          const dueDate = Number(tr.getAttribute('data-due-date')) || Math.floor(Date.now()/1000);
          const amount = parseFloat(document.getElementById('recordAmount').value);
          const remark = document.getElementById('recordRemark').value || null;
          if(!amount || amount <= 0){ msg.innerHTML = '<span class="text-danger">Invalid amount</span>'; return; }
          // enforce scheduled minimum (read from recordAmount.dataset which is set when selecting a row)
          const recordAmountEl = document.getElementById('recordAmount');
          const scheduledMin = parseFloat(recordAmountEl.dataset.scheduledMin || '0') || 0;
          if(scheduledMin > 0 && amount < scheduledMin){ msg.innerHTML = '<span class="text-danger">Amount must be at least NZ$' + scheduledMin.toFixed(2) + '</span>'; return; }

          // check for late fee inputs in the selected row
          const lateFeeInput = tr.querySelector('.lateFeeInput');
          const lateFeeOverrideChk = tr.querySelector('.lateFeeOverride');
          const lateFeeValue = lateFeeInput ? parseFloat(lateFeeInput.value) || 0 : 0;
          const lateFeeOverride = lateFeeOverrideChk ? Boolean(lateFeeOverrideChk.checked) : false;

          const payload = {
            repay_id: repayId,
            loan_id: loanId,
            client_id: clientId,
            amount: amount,
            paid_date: Math.floor(Date.now()/1000),
            remark: remark,
            late_fee: lateFeeValue,
            late_fee_override: lateFeeOverride
          };
          try{
            const r = await fetch('/api/repay-records/payments', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
            if(!r.ok){ const text = await r.text(); throw new Error(text || 'Failed'); }
            const j = await r.json();
            msg.innerHTML = '<span class="text-success">Recorded payment id: '+ (j.payment_id || j.paymentId || j.payment_id || '') +'</span>';
            // refresh data by re-fetching repay records
            const fresh = await fetch('/api/repay-records/?clientNumber=' + encodeURIComponent(clientNumber)).then(r=>r.json());
            renderRepayData(fresh);
          }catch(err){ msg.innerHTML = '<span class="text-danger">Error: '+ err.message +'</span>'; }
        }

        // attach handler for record button
        document.getElementById('recordBtn').addEventListener('click', async function(){ await handleRecordClick(); });
      }

      // initial fetch and render
      fetch('/api/repay-records/?clientNumber=' + encodeURIComponent(clientNumber)).then(r=>r.json()).then(data=>{
        renderRepayData(data);
      }).catch(err=>{ document.getElementById('content').innerHTML = '<p class="text-danger">Error: '+err.message+'</p>'; });
    }
  </script>
</body>
</html>